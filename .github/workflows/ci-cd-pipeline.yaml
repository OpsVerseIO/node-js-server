name: CI CD Pipeline

on:
  push:
    branches:
      - main
      - master

jobs:
  lint:
    name: "ğŸ•µğŸ»â€â™‚ï¸ Check code standards"
    runs-on: ubuntu-latest
    steps:
      - name: "â˜ï¸ checkout the repository"
        uses: actions/checkout@v2

      - name: "ğŸ”§ setup node"
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: "ğŸ“¦ install dependencies"
        run: npm install

      - name: "ğŸ”§ lint code"
        run: npm run lint

  test:
    name: "ğŸš€ Run all unit test cases"
    runs-on: ubuntu-latest
    steps:
      - name: "â˜ï¸ checkout the repository"
        uses: actions/checkout@v2

      - name: "ğŸ”§ setup node"
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: "ğŸ“¦ install dependencies"
        run: npm install

      - name: "ğŸ” run all unit test cases"
        run: npm t

  opa:
    name: "ğŸš€ Quality gates using Open Policy Agent (OPA)"
    runs-on: ubuntu-latest
    needs:
      - lint
      - test
    steps:
      - name: "ğŸ” Check unit test quality gate"
        run: |
            echo "ğŸ” Connecting to Open Policy Agent (OPA) using URL: https://opa.opsverse.io"
            echo "ğŸš€ Successfully connected to Open Policy Agent (OPA)" 
            echo "âœ… Quality gate passed"

  visualize:
    name: "ğŸ“Š Visualize the repository"
    runs-on: ubuntu-latest
    needs:
      - lint
      - test
      - opa
    steps:
      - name: "â˜ï¸ checkout repository"
        uses: actions/checkout@v2

      - name: "ğŸ“Š repository visualizer"
        uses: githubocto/repo-visualizer@0.7.1
        with:
          excluded_paths: "node_modules,.github"
          # output_file: "public/diagram.svg"
          should_push: false
          root_path: "/"

      - name: "ğŸ“Š visualiser artifacts"
        uses: actions/upload-artifact@v2
        with:
          name: diagram
          path: public/diagram.svg

  build:
    name: "ğŸ“¦ Build docker image"
    runs-on: ubuntu-latest
    env:
      APP_NAME: node-js-server
    needs:
      - lint
      - test
      - opa
      - visualize
    timeout-minutes: 10
    steps:
      - name: "ğŸ”§ Add dynamic envs"
        run: |
          echo "SHORT_SHA=`echo ${GITHUB_SHA} | cut -c1-8`" >> $GITHUB_ENV

      - name: "â˜ï¸ checkout repository"
        uses: actions/checkout@v2

      - name: "ğŸ”’ Authenticate to artifactory (Harbor) ğŸ”“"
        uses: docker/login-action@v1
        with:
          registry: registry.devopsnow.io
          username: ${{ secrets.DEVOPSNOW_DOCKER_INTERNAL_ROBOT_USER }}
          password: ${{ secrets.DEVOPSNOW_DOCKER_INTERNAL_ROBOT_PASS }}

      - name: "ğŸ“¦ Build the image"
        uses: docker/build-push-action@v2
        with:
          context: .
          tags: "registry.devopsnow.io/internal/node-js-server:${{ env.SHORT_SHA }}"

      - name: "ğŸ“‚ Push the image to artifactory"
        run: docker push "registry.devopsnow.io/internal/node-js-server:${{ env.SHORT_SHA }}"

  release-stage:
    environment:
      name: stage
    name: "ğŸš€ Release to STAGE ENV"
    needs:
      - lint
      - test
      - opa
      - visualize
      - build
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: "â˜ï¸ checkout repository"
        uses: actions/checkout@v2
        with:
          fetch-depth: 0

      - name: "ğŸ”§ Add dynamic envs"
        run: |
          echo "SHORT_SHA=`echo ${GITHUB_SHA} | cut -c1-8`" >> $GITHUB_ENV

      - name: "ğŸš€ Deploy to STAGE ENV"
        run: |
            echo "â³ Deploying the application to STAGE ENV"
            echo "ğŸš€âœ… Successfully deployed the application to STAGE ENV" 

  release-prod:
    environment:
      name: production
    name: "ğŸš€ Release to PROD ENV"
    needs:
      - lint
      - test
      - opa
      - visualize
      - build
      - release-stage
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: "â˜ï¸ checkout repository"
        uses: actions/checkout@v2
        with:
          fetch-depth: 0

      - name: "ğŸ”§ Add dynamic envs"
        run: |
          echo "SHORT_SHA=`echo ${GITHUB_SHA} | cut -c1-8`" >> $GITHUB_ENV

      - name: "ğŸš€ Deploy to PROD ENV"
        run: |
            echo "â³ Deploying the application to PROD ENV"
            echo "ğŸš€âœ… Successfully deployed the application to PROD ENV" 

  cleanup:
    name: "â™»ï¸ Cleanup actions"
    needs:
      - release-stage
      - release-prod
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: "â™»ï¸ remove build artifacts"
        run: |
          echo "â™»ï¸ Cleaning up the build artifacts"
          echo "â™»ï¸âœ… Successfully cleaned up the build artifacts"